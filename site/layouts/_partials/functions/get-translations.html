{{/* get-translations.html
  Returns translations data based on type (community|preview)

  @param type string - "community" or "preview"
  @return slice - list of translation objects
*/}}

{{- $type := .type | default "community" }}
{{- $translations := slice }}

{{/* Load production and preview data once at the top */}}
{{- $productionLanguagesData := dict }}
{{- $productionLanguageCodes := slice }}
{{- $previewLanguagesData := dict }}
{{/* Determine URLs based on environment */}}
{{- $productionLanguagesUrl := "" }}
{{- $previewLanguagesUrl := "" }}

{{- if eq hugo.Environment "production" }}
  {{- $productionLanguagesUrl = "/languages.json" }}
{{- else }}
  {{- $productionLanguagesUrl = printf "%slanguages.json?v=%d" .Site.Params.productionSiteUrl now.Unix }}
{{- end }}

{{- if eq hugo.Environment "preview" }}
  {{- $previewLanguagesUrl = "/languages.json" }}
{{- else }}
  {{- $previewLanguagesUrl = printf "%slanguages.json?v=%d" .Site.Params.previewSiteUrl now.Unix }}
{{- end }}

{{/* Load production languages */}}
{{- if eq hugo.Environment "production" }}
  {{/* Load local file in production */}}
  {{- $productionLanguagesFile := resources.Get "languages.json" }}
  {{- if $productionLanguagesFile }}
    {{- $productionLanguagesData = $productionLanguagesFile.Content | transform.Unmarshal }}
    {{- if $productionLanguagesData.languages }}
      {{- range $productionLanguagesData.languages }}
        {{- $productionLanguageCodes = $productionLanguageCodes | append .code }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- else }}
  {{/* Load remote file in other environments */}}
  {{- $productionLanguagesResponse := resources.GetRemote $productionLanguagesUrl }}
  {{- if $productionLanguagesResponse }}
    {{- $productionLanguagesData = $productionLanguagesResponse | transform.Unmarshal }}
    {{- if $productionLanguagesData.languages }}
      {{- range $productionLanguagesData.languages }}
        {{- $productionLanguageCodes = $productionLanguageCodes | append .code }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{/* Load preview languages */}}
{{- if eq hugo.Environment "preview" }}
  {{/* Load local file in preview */}}
  {{- $previewLanguagesFile := resources.Get "languages.json" }}
  {{- if $previewLanguagesFile }}
    {{- $previewLanguagesData = $previewLanguagesFile.Content | transform.Unmarshal }}
  {{- end }}
{{- else }}
  {{/* Load remote file in other environments */}}
  {{- $previewLanguagesResponse := resources.GetRemote $previewLanguagesUrl }}
  {{- if $previewLanguagesResponse }}
    {{- $previewLanguagesData = $previewLanguagesResponse | transform.Unmarshal }}
  {{- end }}
{{- end }}

{{/* Process based on type */}}
{{- if eq $type "community" }}
  {{/* Return production languages except English (and reference only in production environment) */}}
  {{- if $productionLanguagesData.languages }}
    {{- range $productionLanguagesData.languages }}
      {{- $shouldInclude := true }}
      {{- if eq hugo.Environment "production" }}
        {{- if eq .status "reference" }}
          {{- $shouldInclude = false }}
        {{- end }}
      {{- end }}
      {{- if eq .code "en" }}
        {{- $shouldInclude = false }}
      {{- end }}
      {{- if $shouldInclude }}
        {{- $translations = $translations | append . }}
      {{- end }}
    {{- end }}
  {{- end }}

{{- else if eq $type "preview" }}
  {{/* Return preview languages that are NOT in production and NOT English */}}
  {{- if $previewLanguagesData.languages }}
    {{- if eq (len $productionLanguageCodes) 0 }}
      {{/* No production languages, return all preview languages except English */}}
      {{- range $previewLanguagesData.languages }}
        {{- if ne .code "en" }}
          {{- $translations = $translations | append . }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{/* Return preview languages that are NOT in production and NOT English */}}
      {{- range $previewLanguagesData.languages }}
        {{- if and (not (in $productionLanguageCodes .code)) (ne .code "en") }}
          {{- $translations = $translations | append . }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}

{{- end }}

{{- return $translations -}}
